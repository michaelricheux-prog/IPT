<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>PoC Planification des Op√©rations (FastAPI + Gantt)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        form input, form button {
            padding: 10px;
            margin-right: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form button {
            cursor: pointer;
            background-color: #5cb85c;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }
        form button:hover {
            background-color: #4cae4c;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        /* Style pour le Gantt (Frappe Gantt) */
        #gantt-container { 
            margin-top: 20px; 
            background: #ffffff;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }
        #gantt-chart svg {
            width: 100%;
            height: auto; /* La hauteur sera g√©r√©e par la librairie */
        }
        /* Styles pour les messages de statut */
        #create-status, #patch-status, #get-status {
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
        }
        #patch-status {
            color: #d9534f;
            background-color: #f2dede;
            border-color: #ebccd1;
        }
        /* Masquer la d√©pendance ID pour l'utilisateur */
        .hidden-label {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üè≠ Outil de Planification des Op√©rations (PoC)</h1>
    <p>Backend: FastAPI | Frontend: HTML/JS/Frappe Gantt | BDD: SQLAlchemy</p>

    <div id="gantt-container" class="section">
        <h2>üìä Diagramme de Gantt des Op√©rations</h2>
        <svg id="gantt-chart"></svg>
    </div>

    <div class="section">
        <h2>‚ûï Cr√©er une nouvelle Op√©ration (POST)</h2>
        <form id="create-form">
            <input type="text" id="create-nom" placeholder="Nom de l'Op√©ration" required>
            <input type="number" id="create-quantite" placeholder="Quantit√© √† produire" step="0.01" required>
            <input type="text" id="create-unite" placeholder="Unit√©" required>
            <input type="text" id="create-categorie" placeholder="Cat√©gorie (ex: Montage)" required>
            <br>
            <label class="hidden-label" for="create-bloc_precedent_id">D√©pendance ID:</label>
            <input type="number" id="create-bloc_precedent_id" placeholder="ID Op√©ration Pr√©c√©dente (Optionnel)">
            <button type="submit">Cr√©er l'Op√©ration</button>
        </form>
        <p id="create-status"></p>
    </div>

    <div class="section">
        <h2>‚úèÔ∏è Modifier une Op√©ration (PATCH)</h2>
        <form id="update-form">
            <input type="number" id="update-id" placeholder="ID de l'Op√©ration √† modifier" required>
            <input type="text" id="update-nom" placeholder="Nouveau Nom (optionnel)">
            <input type="number" id="update-quantite" placeholder="Nouvelle Quantit√© (optionnel)" step="0.01">
            <input type="text" id="update-unite" placeholder="Nouvelle Unit√© (optionnel)">
            <input type="text" id="update-categorie" placeholder="Nouvelle Cat√©gorie (optionnel)">
            <br>
            <input type="number" id="update-bloc_precedent_id" placeholder="Nouvel ID Pr√©c√©dent (D√©pendance)">
            <label>
                <input type="checkbox" id="update-est_realisee"> Op√©ration R√©alis√©e ?
            </label>
            <button type="submit">Appliquer les Modifications</button>
        </form>
        <p id="patch-status"></p>
    </div>

    <div class="section">
        <h2>üìã Liste des Op√©rations (GET)</h2>
        <p id="get-status"></p>
        <table id="blocs-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Quantit√©</th>
                    <th>Unit√©</th>
                    <th>Cat√©gorie</th>
                    <th>D√©pend de (ID)</th>
                    <th>R√©alis√©e</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

<script>
    const API_URL = 'http://127.0.0.1:8000/blocs/';
    
    // ----------------------------------------------------------------------
    // FONCTION PRINCIPALE : CHARGEMENT ET AFFICHAGE DU GANTT ET DU TABLEAU
    // ----------------------------------------------------------------------
    async function fetchBlocsAndDrawGantt() {
        const tbody = document.querySelector('#blocs-table tbody');
        const statusElement = document.getElementById('get-status');
        tbody.innerHTML = '<tr><td colspan="8">Chargement...</td></tr>'; // Colspan = 8
        statusElement.textContent = '';

        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            const blocs = await response.json();
            
            // --- Pr√©paration des donn√©es pour le Gantt ---
            let ganttTasks = [];
            let today = new Date();
            tbody.innerHTML = ''; 

            const blocMap = new Map(blocs.map(b => [b.id, b]));
            
            if (blocs.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="8">Aucune op√©ration trouv√©e. Cr√©ez-en une !</td></tr>';
            } else {
                blocs.forEach((bloc, index) => {
                    // Calcul de la date de d√©but fictive (pour le PoC simple)
                    let startDay = new Date(today);
                    // D√©cale chaque t√¢che d'un jour pour l'affichage s√©quentiel
                    startDay.setDate(today.getDate() + index); 
                    
                    const formatDate = (date) => date.toISOString().split('T')[0];
                    
                    // D√©pendance : utilise l'ID du bloc pr√©c√©dent (converti en string pour Frappe Gantt)
                    const dependencies = bloc.bloc_precedent_id ? String(bloc.bloc_precedent_id) : '';
                    
                    ganttTasks.push({
                        id: String(bloc.id),
                        name: bloc.nom,
                        start: formatDate(startDay),
                        end: formatDate(new Date(startDay.getTime() + 86400000)), // Dure 1 jour
                        progress: bloc.est_realisee ? 100 : 0, 
                        dependencies: dependencies,
                        custom_class: bloc.est_realisee ? 'gantt-completed' : 'gantt-pending'
                    });

                    // Mise √† jour du tableau standard
                    const row = tbody.insertRow();
                    row.insertCell().textContent = bloc.id;
                    row.insertCell().textContent = bloc.nom;
                    row.insertCell().textContent = bloc.quantite;
                    row.insertCell().textContent = bloc.unite;
                    row.insertCell().textContent = bloc.categorie;
                    row.insertCell().textContent = bloc.bloc_precedent_id || 'N/A';
                    row.insertCell().textContent = bloc.est_realisee ? '‚úÖ Oui' : '‚ùå Non';

                    // Cr√©e le bouton d'action
                    const actionCell = row.insertCell();
                    const selectButton = document.createElement('button');
                    selectButton.textContent = 'S√©lectionner';
                    selectButton.onclick = () => populateUpdateForm(bloc.id); 
                    selectButton.style.padding = '5px';
                    selectButton.style.width = 'auto';
                    actionCell.appendChild(selectButton);
                });
            }

            // --- Initialisation du Gantt ---
            const ganttElement = document.getElementById('gantt-chart');
            if (ganttTasks.length > 0) {
                 // S'assure de nettoyer avant de recr√©er
                ganttElement.innerHTML = ''; 
                new Gantt(ganttElement, ganttTasks, {
                    header_height: 50,
                    column_width: 30,
                    step: 24, // 1 jour
                    view_modes: ['Day', 'Week', 'Month'],
                    bar_height: 20,
                    padding: 18,
                    view_mode: 'Week',
                    language: 'fr',
                    custom_popup_html: function(task) {
                        return `<div class="details-container">
                            <h5>${task.name} (ID: ${task.id})</h5>
                            <p>D√©pend de: ${task.dependencies || 'Aucune'}</p>
                            <p>Statut: ${task.progress === 100 ? 'Termin√©e' : 'En attente'}</p>
                        </div>`;
                    }
                });
            } else {
                ganttElement.innerHTML = "<p>Aucune op√©ration √† afficher dans le Gantt.</p>";
            }
            
            statusElement.textContent = `Liste et Gantt charg√©s (${blocs.length} √©l√©ments)`;
            
        } catch (error) {
            statusElement.textContent = `Erreur de connexion : ${error.message}. V√©rifiez si l'API est lanc√©e !`;
            document.getElementById('gantt-chart').innerHTML = "<p>Erreur lors du chargement des donn√©es pour le Gantt.</p>";
        }
    }


    // ----------------------------------------------------------------------
    // GESTIONNAIRES DE FORMULAIRES
    // ----------------------------------------------------------------------

    // Fonction pour pr√©-remplir le formulaire de modification (S√©lectionner)
    async function populateUpdateForm(id) {
        const statusElement = document.getElementById('patch-status');
        statusElement.textContent = `Chargement du bloc ID ${id}...`;

        try {
            const response = await fetch(`${API_URL}${id}`);
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            const bloc = await response.json();

            // Remplissage des champs du formulaire de modification
            document.getElementById('update-id').value = bloc.id;
            document.getElementById('update-nom').value = bloc.nom;
            document.getElementById('update-quantite').value = bloc.quantite;
            document.getElementById('update-unite').value = bloc.unite;
            document.getElementById('update-categorie').value = bloc.categorie;
            document.getElementById('update-bloc_precedent_id').value = bloc.bloc_precedent_id || '';
            document.getElementById('update-est_realisee').checked = bloc.est_realisee;

            statusElement.textContent = `Bloc ID ${id} s√©lectionn√©. Modifiez les champs ci-dessus.`;

        } catch (error) {
            statusElement.textContent = `Erreur lors du chargement du bloc ID ${id}: ${error.message}`;
        }
    }

    // Gestion de la CR√âATION (POST)
    document.getElementById('create-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusElement = document.getElementById('create-status');
        
        const bloc_precedent_id_val = document.getElementById('create-bloc_precedent_id').value;

        const newBloc = {
            nom: document.getElementById('create-nom').value,
            quantite: parseFloat(document.getElementById('create-quantite').value),
            unite: document.getElementById('create-unite').value,
            categorie: document.getElementById('create-categorie').value,
            // N'envoie le champ que s'il y a une valeur
            bloc_precedent_id: bloc_precedent_id_val ? parseInt(bloc_precedent_id_val) : null 
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newBloc)
            });

            if (response.status === 201) {
                statusElement.textContent = `Op√©ration '${newBloc.nom}' cr√©√©e avec succ√®s !`;
                document.getElementById('create-form').reset();
                fetchBlocsAndDrawGantt(); 
            } else {
                 const errorData = await response.json();
                 // Capture les erreurs de type 400 (cycle) du Backend
                if (response.status === 400 && errorData.detail) {
                    statusElement.textContent = `üö´ ERREUR DE R√àGLE M√âTIER : ${errorData.detail}`;
                } else {
                    statusElement.textContent = `√âchec de la cr√©ation: ${errorData.detail || response.statusText}`;
                }
            }
        } catch (error) {
            statusElement.textContent = `Erreur r√©seau : Impossible de contacter l'API.`;
        }
    });

    // Gestion de la MODIFICATION (PATCH)
    document.getElementById('update-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusElement = document.getElementById('patch-status');
        statusElement.style.color = '#d9534f'; // R√©tablir la couleur d'erreur par d√©faut
        
        const blocId = document.getElementById('update-id').value;

        const updateData = {};
        const nom = document.getElementById('update-nom').value;
        const quantite = document.getElementById('update-quantite').value;
        const unite = document.getElementById('update-unite').value;
        const categorie = document.getElementById('update-categorie').value;
        const bloc_precedent_id_val = document.getElementById('update-bloc_precedent_id').value;
        const est_realisee = document.getElementById('update-est_realisee').checked;

        if (nom) updateData.nom = nom;
        if (quantite) updateData.quantite = parseFloat(quantite);
        if (unite) updateData.unite = unite;
        if (categorie) updateData.categorie = categorie;
        
        // Ajout des nouveaux champs s'ils ont √©t√© saisis/coch√©s
        if (bloc_precedent_id_val !== '') {
            updateData.bloc_precedent_id = bloc_precedent_id_val ? parseInt(bloc_precedent_id_val) : null;
        }

        // Le champ est_realisee est toujours envoy√© si la case est pr√©sente
        updateData.est_realisee = est_realisee;
        
        if (Object.keys(updateData).length === 0) {
            statusElement.textContent = "Veuillez remplir au moins un champ de modification.";
            return;
        }

        try {
            const response = await fetch(`${API_URL}${blocId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                const updatedBloc = await response.json();
                statusElement.style.color = '#5cb85c'; // Couleur verte pour le succ√®s
                statusElement.textContent = `Op√©ration ID ${blocId} modifi√©e avec succ√®s ! (Nom: ${updatedBloc.nom})`;
                document.getElementById('update-form').reset();
                fetchBlocsAndDrawGantt(); 
            } else {
                const errorData = await response.json();
                
                // --- GESTION DE L'ERREUR 400 (Cycle) ---
                if (response.status === 400 && errorData.detail) {
                    statusElement.textContent = `üö´ ERREUR DE R√àGLE M√âTIER : ${errorData.detail}`;
                } else {
                    statusElement.textContent = `√âchec de la modification: ${errorData.detail || response.statusText}`;
                }
            }

        } catch (error) {
            statusElement.textContent = `Erreur r√©seau : Impossible de contacter l'API pour la mise √† jour.`;
        }
    });

    // Charger la liste et le Gantt au chargement de la page
    document.addEventListener('DOMContentLoaded', fetchBlocsAndDrawGantt);
</script>

</body>
</html>